<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Ejecutivo - Colegio de Bachilleres</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 25px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .filters {
            margin: 25px 0;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }
        .icne-stats {
            display: Flex;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            justify-items: center;
            max-width: 1200px;
            margin: 0 auto;
            gap: 1.5rem;
            padding: 1rem;
        }
        .stat-box {
            text-align: center;
            padding: 1.2rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 250px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }
        .chart-container {
            padding: 20px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        #fileInput {
            margin: 20px 0;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            width: 300px;
        }
        select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin: 0 10px;
        }
        .metric-header {
            font-size: 18px;
            color: #34495e;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        .vertical-chart {
            height: 400px !important;
        }
        .table-responsive {
            overflow-x: auto;   
        }       
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }
        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .table tbody tr:hover {
            background-color: #f1f8ff;
        }
        .retry-button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        .retry-button:hover {
            background-color: #2980b9;

        }    

        .chart-container.ingresChart {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 360px; /* 游녣 Altura fija */
        }

            /* 游댢 Ajuste de tama침o para los contenedores de gr치ficas circulares */
        #suficienciaInglesChart,
        #comprensionInglesDINGChart {
            width: 300px !important;
            height: 300px !important;
        }
        

    </style>
</head>
<body>
    <div class="container">
            <!-- 游댢 Encabezado corregido -->
        <div style="text-align: center; margin-bottom: 20px; background-color: #61828d; padding: 10px;">
            <img src="https://www.ujat.mx/Content/images/escudo.png" alt="Logo" style="height: 80px; display:block; margin: 0 auto 10px auto;">
            <h1 style="margin: 0; color: white;">Resultados del Proceso de Admisi칩n</h1>
            <h1 style="margin: 0; color: white;">Licenciatura y TSU</h1>
            <h1 style="margin: 0; color: white;">Dashboard</h1>
        </div>

        <div id="loadingMessage" class="loading">
            Cargando datos del archivo Excel...
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            <strong>Error:</strong> <span id="errorText"></span>
            <br>
            <button class="retry-button" onclick="cargarExcelEmbebido()">Reintentar</button>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Filtros -->
            <div class="filters">
                <select id="sistemaSelect" onchange="updatePlantelOptions(); updateDashboard()" disabled>
                    <option value="TODOS">Todos los Sistemas</option>
                </select>
                <select id="plantelSelect" onchange="updateDashboard()" disabled>
                    <option value="TODOS">Todos los Planteles</option>
                </select>
            </div>

            <!-- Estad칤sticas generales -->
            <div class="icne-stats">
                <div class="stat-box">
                    <div class="stat-label">M츼XIMO DE ICNE</div>
                    <div class="stat-value" id="maxIcne">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">M칈NIMO DE ICNE</div>
                    <div class="stat-value" id="minIcne">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">PROMEDIO DE ICNE</div>
                    <div class="stat-value" id="avgIcne">-</div>
                </div>
            </div>
                
            <div class="icne-stats">    
                <div class="stat-box">
                    <div class="stat-label">TOTAL ASPIRANTES</div>
                    <div class="stat-value" id="totalAspirantes">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ACEPTADOS</div>
                    <div class="stat-value" id="totalAceptados">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">NO ACEPTADOS</div>
                    <div class="stat-value" id="totalNoAceptados">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">% ACEPTACI칍N</div>
                    <div class="stat-value" id="porcentajeAceptacion">-</div>
                </div>
            </div>

            <!-- Gr치ficas -->
            <div class="grid-container">
                <!-- Gr치ficas de habilidades -->
                <div class="chart-container">
                    <div class="metric-header">Comprensi칩n Lectora</div>
                    <canvas id="comprensionChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="metric-header">Redacci칩n Indirecta</div>
                    <canvas id="redaccionChart"></canvas>
                </div>
                <div class="chart-container">
                    <div class="metric-header">Pensamiento Matem치tico</div>
                    <canvas id="matematicasChart"></canvas>
                </div>
                <div class="chart-container" style="grid-column: 1 / 3;">
                    <div class="metric-header">Nivel de Ingl칠s</div>
                    <div style="display: flex; justify-content: space-around;">
                        <div>
                            <canvas id="suficienciaInglesChart" width="300" height="300"></canvas>
                            <center>Redacci칩n Indirecta</center>
                        </div>
                        <div>
                            <canvas id="comprensionInglesDINGChart" width="300" height="300"></canvas>
                            <center>Comprensi칩n Lectora</center>
                        </div>
                    </div>
                </div>
                
                <!-- Gr치fica de Top 10 Carreras ocupando toda la fila -->
                <div class="chart-container" style="grid-column: 1 / 3;">
                    <div class="metric-header">Top 10 Carreras M치s Solicitadas</div>
                    <canvas id="topCarrerasChart" class="vertical-chart"></canvas>
                </div>
                <!-- Gr치fica de Carreras del 츼rea de la Salud en la fila siguiente -->
                <div class="chart-container" style="grid-column: 3 / -1;">
                    <div class="metric-header">Carreras del 츼rea de la Salud</div>
                    <canvas id="carrerasSaludChart" class="vertical-chart"></canvas>
                </div>
                
                <!-- Nuevas gr치ficas de planteles -->
                <div class="chart-container" style="grid-column: 1 / 4; display: none;" id="plantelesAceptadosContainer">
                    <div class="metric-header">Top 10 Planteles con Mayor N칰mero de Aceptados</div>
                    <canvas id="topPlantelesAceptadosChart" class="vertical-chart"></canvas>
                </div>
                <div class="chart-container" style="grid-column: 1 / -1; display: none;" id="plantelesNoAceptadosContainer">
                    <div class="metric-header">Top 10 Planteles con Mayor N칰mero de No Aceptados</div>
                    <canvas id="topPlantelesNoAceptadosChart" class="vertical-chart"></canvas>
                </div>
            </div>
        
            <!-- Top 10 mejores puntajes ICNE -->
            <div class="chart-container" style="grid-column: 1 / -1;">
                <div class="metric-header">Top 10 Mejores Puntajes ICNE</div>
                <div class="table-responsive">
                    <table id="topIcneTable" class="table">
                        <thead>
                            <tr>
                                <th>Ubicaci칩n</th>
                                <th>Carrera</th>
                                <th>Nombre</th>
                                <th>Apellido Paterno</th>
                                <th>Apellido Materno</th>
                                <th>ICNE</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se llenar치n din치micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let datos = [];
        let charts = {
            comprension: null,
            redaccion: null,
            matematicas: null,
            inglesComprension: null,
            inglesRedaccion: null,
            suficienciaIngles: null,
            comprensionInglesDING: null,
            topCarreras: null,
            carrerasSalud: null,
            topPlantelesAceptados: null,
            topPlantelesNoAceptados: null
        };

        function mostrarError(mensaje) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorText').textContent = mensaje;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function mostrarContenido() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        async function cargarExcelEmbebido() {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';

                console.log('Iniciando carga del archivo Excel...');
                
                const response = await fetch('/api/fetch-excel');
                
                if (!response.ok) {
                    let errorMessage = `Error HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        console.error('Error del servidor:', errorData);
                    } catch (e) {
                        console.error('Error al parsear respuesta de error:', e);
                    }
                    throw new Error(errorMessage);
                }

                console.log('Respuesta recibida, procesando archivo...');
                const arrayBuffer = await response.arrayBuffer();
                
                if (arrayBuffer.byteLength === 0) {
                    throw new Error("El archivo recibido est치 vac칤o");
                }

                console.log(`Archivo cargado: ${arrayBuffer.byteLength} bytes`);

                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                    throw new Error("El archivo Excel no contiene hojas de c치lculo");
                }

                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                console.log(`Datos procesados: ${jsonData.length} filas`);
                
                if (jsonData.length <= 1) {
                    throw new Error("El archivo Excel est치 vac칤o o no tiene el formato esperado");
                }

                // Procesar datos
                const headers = jsonData[0];
                datos = jsonData.slice(1)
                    .filter(row => row && row.length > 0)
                    .map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                if (datos.length === 0) {
                    throw new Error("No se encontraron datos v치lidos en el archivo");
                }

                console.log(`Datos finales procesados: ${datos.length} registros`);

                // Configurar selectores de filtros
                const sistemaSelect = document.getElementById('sistemaSelect');
                const plantelSelect = document.getElementById('plantelSelect');
                sistemaSelect.disabled = false;
                plantelSelect.disabled = false;

                // Limpiar opciones anteriores
                sistemaSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());
                plantelSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());

                // Poblar opciones para Sistema
                const sistemas = [...new Set(datos.map(item => item['SISTEMA']).filter(Boolean))];
                sistemas.forEach(sis => {
                    const option = document.createElement('option');
                    option.value = sis;
                    option.textContent = sis;
                    sistemaSelect.appendChild(option);
                });

                updatePlantelOptions();
                updateDashboard();
                mostrarContenido();

            } catch (error) {
                console.error("Error detallado:", error);
                mostrarError(`Error al cargar datos: ${error.message}`);
            }
        }

        function updatePlantelOptions() {
            const sistemaSelect = document.getElementById('sistemaSelect');
            const plantelSelect = document.getElementById('plantelSelect');
            const selectedSistema = sistemaSelect.value;
            
            plantelSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());
            
            let planteles = [];
            if (selectedSistema === "TODOS") {
                planteles = [...new Set(datos.map(item => item['PLANTEL']).filter(Boolean))];
            } else {
                planteles = [...new Set(datos.filter(item => item['SISTEMA'] === selectedSistema)
                                            .map(item => item['PLANTEL']).filter(Boolean))];
            }
            
            planteles.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantelSelect.appendChild(option);
            });
            plantelSelect.value = "TODOS";
        }

        function actualizarTablaTopIcne(filteredData) {
            const tableBody = document.querySelector('#topIcneTable tbody');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (filteredData.length > 0) {
                console.log("Campos disponibles:", Object.keys(filteredData[0]));
            }

            const topData = [...filteredData]
                .filter(item => item.ICNE)
                .sort((a, b) => parseFloat(b.ICNE || 0) - parseFloat(a.ICNE || 0))
                .slice(0, 10);

            topData.forEach(item => {
                const ubicacion = `${item.SISTEMA || ''} - ${item.PLANTEL || ''}`;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${ubicacion}</td>
                    <td>${item.CARRERA || '-'}</td>
                    <td>${item.NOMBRE || '-'}</td>
                    <td>${item.PRIM_APE || '-'}</td>
                    <td>${item.SEGU_APE || '-'}</td>
                    <td><strong>${parseFloat(item.ICNE || 0).toFixed(0)}</strong></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateDashboard() {
            if (datos.length === 0) return;
            
            const selectedSistema = document.getElementById('sistemaSelect').value;
            const selectedPlantel = document.getElementById('plantelSelect').value;
            const filteredData = datos.filter(item => {
                let condition = true;
                if (selectedSistema !== 'TODOS') condition = condition && (item['SISTEMA'] === selectedSistema);
                if (selectedPlantel !== 'TODOS') condition = condition && (item['PLANTEL'] === selectedPlantel);
                return condition;
            });

            // Actualizar estad칤sticas generales
            const totalAspirantes = filteredData.length;
            const totalAceptados = filteredData.filter(item => item.DICTAMEN?.toUpperCase() === 'ACEPTADO').length;
            const totalNoAceptados = totalAspirantes - totalAceptados;
            const porcentajeAceptacion = totalAspirantes > 0 ? ((totalAceptados / totalAspirantes) * 100).toFixed(1) : 0;

            document.getElementById('totalAspirantes').textContent = totalAspirantes;
            document.getElementById('totalAceptados').textContent = totalAceptados;
            document.getElementById('totalNoAceptados').textContent = totalNoAceptados;
            document.getElementById('porcentajeAceptacion').textContent = porcentajeAceptacion + '%';

            // Actualizar estad칤sticas ICNE
            const icneValues = filteredData.map(item => parseFloat(item.ICNE) || 0);
            const maxIcne = icneValues.length ? Math.max(...icneValues).toFixed(0) : '-';
            const minIcne = icneValues.length ? Math.min(...icneValues).toFixed(0) : '-';
            const avgIcne = icneValues.length ? (icneValues.reduce((a, b) => a + b, 0) / icneValues.length).toFixed(0) : '-';
        
            document.getElementById('maxIcne').textContent = maxIcne;
            document.getElementById('minIcne').textContent = minIcne;
            document.getElementById('avgIcne').textContent = avgIcne;

            // Mostrar/ocultar contenedores seg칰n filtros
            const showPlantelCharts = selectedSistema !== 'TODOS' && selectedPlantel === 'TODOS';
            
            document.getElementById('plantelesAceptadosContainer').style.display = showPlantelCharts ? 'block' : 'none';
            document.getElementById('plantelesNoAceptadosContainer').style.display = showPlantelCharts ? 'block' : 'none';

            // Mover la tabla de Top 10 ICNE al final
            const topIcneContainer = document.querySelector('#topIcneTable').closest('.chart-container');
            topIcneContainer.parentNode.appendChild(topIcneContainer);

            // Destruir gr치ficas anteriores si est치n ocultas
            Object.keys(charts).forEach(key => {
                if (key !== 'topPlantelesAceptados' && key !== 'topPlantelesNoAceptados' && charts[key]) {
                    charts[key].destroy();
                    charts[key] = null;
                }
            });

            // Funci칩n para calcular promedios
            const promedio = (key) => {
                const total = filteredData.reduce((sum, item) => sum + (parseFloat(item[key]) || 0), 0);
                return filteredData.length ? (total / filteredData.length).toFixed(2) : 0;
            };

            // Configuraci칩n com칰n para gr치ficas de habilidades
            const commonOptions = {
                indexAxis: 'y',
                responsive: true,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        color: '#ffffff',
                        font: { 
                            weight: 'bold', 
                            size: 14 
                        },
                        formatter: value => `${value}%`,
                        offset: 10
                    }
                },
                scales: { x: { max: 100, beginAtZero: true } }
            };

            // Crear gr치ficas de habilidades
            charts.comprension = crearGraficaHabilidad(
                'comprensionChart',
                ['츼mbito Estudio', '츼mbito de Participaci칩n Social', '츼mbito Literario'],
                ['PCLE_AE', 'PCLE_APS', 'PCLE_AL'],
                ['#3498db', '#2ecc71', '#9b59b6'],
                promedio,
                commonOptions
            );
           
            charts.redaccion = crearGraficaHabilidad(
                'redaccionChart',
                ['츼mbito Estudio', '츼mbito Participaci칩n Social'],
                ['PRIN_ES', 'PRIN_PS'],
                ['#e67e22', '#f1c40f'],
                promedio,
                commonOptions
            );

            charts.matematicas = crearGraficaHabilidad(
                'matematicasChart',
                ['Comprensi칩n Matem치tica', 'Matematizaci칩n'],
                ['PPMA_CM', 'PPMA_MA'],
                ['#e74c3c', '#1abc9c'],
                promedio,
                commonOptions
            );

            // Crear gr치ficas de ingl칠s
            crearGraficasIngles(filteredData);

            // Procesar y mostrar gr치ficas de carreras
            actualizarGraficaCarreras('topCarrerasChart', filteredData);
            actualizarGraficaCarreras('carrerasSaludChart', filteredData, [
                'M칄DICO CIRUJANO',
                'CIRUJANO DENTISTA',
                'LICENCIADO EN ENFERMER칈A',
                'LICENCIADO EN PSICOLOG칈A'
            ]);

            // Crear gr치ficas de planteles solo si se cumple la condici칩n
            if (showPlantelCharts) {
                const dataAceptados = procesarPlanteles(filteredData, 'aceptados');
                crearGraficaPlanteles(
                    'topPlantelesAceptadosChart',
                    dataAceptados,
                    '#27ae60',
                    'Aceptados'
                );

                const dataNoAceptados = procesarPlanteles(filteredData, 'noAceptados');
                crearGraficaPlanteles(
                    'topPlantelesNoAceptadosChart',
                    dataNoAceptados,
                    '#e74c3c',
                    'No Aceptados'
                );
            }

            actualizarTablaTopIcne(filteredData);
        }

        // Funci칩n para crear gr치ficas de habilidades
        function crearGraficaHabilidad(canvasId, labels, keys, colores, promedio, commonOptions) {
            return new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Porcentaje',
                        data: keys.map(k => promedio(k)),
                        backgroundColor: colores,
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { 
                            display: false
                        },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#ffffff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: value => `${value}%`,
                            offset: 10
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
            
        function crearGraficasIngles(data) {
            const procesarIngles = (campo, colores) => {
                const counts = data.reduce((acc, item) => {
                    const valor = parseInt(item[campo]) || 0;
                    acc[valor === 2 ? 1 : 0]++;
                    return acc;
                }, [0, 0]);
                
                return {
                    labels: ['No Satisfactorio', 'Satisfactorio'],
                    datasets: [{
                        data: counts,
                        backgroundColor: colores
                    }]
                };
            };

            // Destruir gr치ficas anteriores si existen
            if (charts.suficienciaIngles) {
                charts.suficienciaIngles.destroy();
            }
            if (charts.comprensionInglesDING) {
                charts.comprensionInglesDING.destroy();
            }

            charts.suficienciaIngles = new Chart(document.getElementById('suficienciaInglesChart'), {
                type: 'doughnut',
                data: procesarIngles('DING_RI', ['#e74c3c', '#2ecc71']),
                options: configPie,
                plugins: [ChartDataLabels]
            });

            charts.comprensionInglesDING = new Chart(document.getElementById('comprensionInglesDINGChart'), {
                type: 'doughnut',
                data: procesarIngles('DING_CL', ['#e74c3c', '#2ecc71']),
                options: configPie,
                plugins: [ChartDataLabels]
            });
        }

        function actualizarGraficaCarreras(chartId, filteredData, filtroCarreras = null) {
            const ctx = document.getElementById(chartId);
            const data = procesarCarreras(filteredData, filtroCarreras);
            
            if (charts[chartId]) {
                charts[chartId].destroy();
            }
            
            charts[chartId] = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { stacked: false }, y: { stacked: false, beginAtZero: true } },
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: value => value > 0 ? value : ''
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function procesarPlanteles(filteredData, tipo) {
            const plantelData = filteredData.reduce((acc, item) => {
                const plantel = item.PLANTEL;
                if (!plantel) return acc;
            
                if (!acc[plantel]) acc[plantel] = 0;
            
                if ((tipo === 'aceptados' && item.DICTAMEN?.toUpperCase() === 'ACEPTADO') ||
                    (tipo === 'noAceptados' && item.DICTAMEN?.toUpperCase() !== 'ACEPTADO')) {
                    acc[plantel]++;
                }
            
                return acc;
            }, {});

            return Object.entries(plantelData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([nombre, cantidad]) => ({ nombre, cantidad }));
        }

        // Funci칩n auxiliar para crear gr치ficas de planteles
        function crearGraficaPlanteles(canvasId, data, color, label) {
            const ctx = document.getElementById(canvasId);
            
            if (charts[canvasId]) charts[canvasId].destroy();
            
            charts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.nombre),
                    datasets: [{
                        label: label,
                        data: data.map(d => d.cantidad),
                        backgroundColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: value => value
                        }
                    },
                    scales: {
                        x: { beginAtZero: true },
                        y: { ticks: { autoSkip: false } }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // Funci칩n modificada para recibir filteredData como par치metro
        function procesarCarreras(filteredData, filtro = null) {
            const carrerasData = filteredData.reduce((acc, item) => {
                const carrera = item.CARRERA?.toUpperCase();
                if (!carrera) return acc;
                
                if (!acc[carrera]) acc[carrera] = { aceptados: 0, noAceptados: 0 };
                
                item.DICTAMEN?.toUpperCase() === 'ACEPTADO' 
                    ? acc[carrera].aceptados++ 
                    : acc[carrera].noAceptados++;
                
                return acc;
            }, {});

            let carreras = Object.entries(carrerasData);
            
            if (filtro) {
                carreras = carreras.filter(([nombre]) => filtro.includes(nombre));
            } else {
                carreras = carreras.sort((a, b) => 
                    (b[1].aceptados + b[1].noAceptados) - (a[1].aceptados + a[1].noAceptados)
                ).slice(0, 10);
            }

            return {
                labels: carreras.map(([nombre]) => nombre),
                datasets: [
                    {
                        label: 'Aceptados',
                        data: carreras.map(([, datos]) => datos.aceptados),
                        backgroundColor: '#27ae60'
                    },
                    {
                        label: 'No Aceptados',
                        data: carreras.map(([, datos]) => datos.noAceptados),
                        backgroundColor: '#e74c3c'
                    }
                ]
            };
        }

        // Configuraci칩n com칰n para gr치ficas de tipo pie
        // 游댢 Configuraci칩n com칰n para gr치ficas de tipo pie (ajustada)
const configPie = {
    responsive: true,
    maintainAspectRatio: false, // 游녣 Esto permite que las gr치ficas usen el tama침o del contenedor
    plugins: {
        legend: {
            position: 'top',
            labels: {
                font: { size: 12 },
                generateLabels: function(chart) {
                    const data = chart.data;
                    if (data.labels.length && data.datasets.length) {
                        return data.labels.map((label, i) => {
                            const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                            const value = data.datasets[0].data[i];
                            const percentage = total === 0 ? '0%' : ((value / total) * 100).toFixed(2) + '%';
                            
                            return {
                                text: `${label}: ${value} (${percentage})`,
                                fillStyle: data.datasets[0].backgroundColor[i],
                                hidden: false,
                                index: i
                            };
                        });
                    }
                    return [];
                }
            }
        },
        tooltip: {
            callbacks: {
                label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = total === 0 ? '0%' : ((value / total) * 100).toFixed(1) + '%';
                    return `${label}: ${value} (${percentage})`;
                }
            }
        },
        datalabels: {
            color: '#ffffff',
            font: { 
                weight: 'bold', 
                size: 14 
            },
            formatter: (value, context) => {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                return total === 0 ? '0%' : ((value / total) * 100).toFixed(1) + '%';
            },
            anchor: 'center',
            align: 'middle'
        }
    }
};


        // Cargar el Excel autom치ticamente al abrir la p치gina
        window.onload = cargarExcelEmbebido;
    </script>
</body>
</html>


