<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard Ejecutivo - Colegio de Bachilleres</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            margin: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .filters {
            margin: 25px 0;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        /* Grid principal responsive */
        .grid-container {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        /* Desktop: Grid de 3 columnas */
        @media (min-width: 769px) {
            .grid-container {
                grid-template-columns: repeat(3, 1fr);
            }
            
            /* Gráficas individuales ocupan 1 columna */
            .chart-container:not(.full-width):not(.two-columns) {
                grid-column: span 1;
            }
            
            /* Gráficas especiales que ocupan 2 columnas */
            .chart-container.two-columns {
                grid-column: span 2;
            }
            
            /* Gráficas que ocupan toda la fila */
            .chart-container.full-width {
                grid-column: 1 / -1;
            }
        }

        /* Tablet: Grid de 2 columnas */
        @media (min-width: 481px) and (max-width: 768px) {
            .grid-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .chart-container:not(.full-width) {
                grid-column: span 1;
            }
            
            .chart-container.full-width,
            .chart-container.two-columns {
                grid-column: 1 / -1;
            }
        }

        /* Móvil: Una sola columna */
        @media (max-width: 480px) {
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                grid-column: 1;
            }
        }

        /* Estadísticas generales */
        .icne-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            justify-items: center;
            gap: 1rem;
            padding: 0.5rem;
            margin-bottom: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 220px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        /* Contenedores de gráficas */
        .chart-container {
            padding: 15px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 100%;
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        /* Contenedor específico para gráficas de inglés */
        .ingles-charts-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            min-height: 360px;
        }

        .pie-wrapper {
            width: 280px;
            height: 280px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .pie-wrapper canvas {
            width: 100% !important;
            height: 100% !important;
        }

        /* Etiquetas para gráficas de inglés */
        .ingles-labels {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            text-align: center;
            font-weight: bold;
            color: #34495e;
        }

        /* Controles del formulario */
        #fileInput {
            margin: 20px 0;
            padding: 12px;
            border: 2px solid #3498db;
            border-radius: 8px;
            width: 300px;
        }

        select {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 14px;
            margin: 0 10px;
        }

        .metric-header {
            font-size: 18px;
            color: #34495e;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
            flex-shrink: 0;
        }

        /* Gráficas verticales */
        .vertical-chart {
            width: 100% !important;
            min-height: 400px !important;
            flex: 1;
        }

        /* Tablas responsive */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            flex: 1;
        }

        .table {
            font-size: 14px;
            white-space: nowrap;
            width: 100%;
        }

        .table th, .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        .table tbody tr:hover {
            background-color: #f1f8ff;
        }

        .retry-button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }

        .retry-button:hover {
            background-color: #2980b9;
        }

        /* Canvas responsive */
        canvas {
            max-width: 100% !important;
            height: auto !important;
        }

        /* Media queries específicas para móvil */
        @media (max-width: 768px) {
            body {
                margin: 10px;
            }
            
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .stat-value {
                font-size: 20px;
            }
            
            .stat-label {
                font-size: 12px;
            }
            
            .chart-container {
                min-height: 250px;
                padding: 10px;
            }
            
            .pie-wrapper {
                width: 200px;
                height: 200px;
            }
            
            .ingles-charts-container {
                flex-direction: column;
                min-height: auto;
            }
            
            .ingles-labels {
                flex-direction: column;
                gap: 10px;
            }
            
            .metric-header {
                font-size: 16px;
            }
        }

        @media (max-width: 480px) {
            .icne-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .stat-box {
                max-width: none;
                padding: 0.75rem;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .stat-label {
                font-size: 11px;
            }
            
            .pie-wrapper {
                width: 180px;
                height: 180px;
            }
            
            select {
                width: 90%;
                margin: 5px 0;
            }
        }

        /* Orientación landscape en móvil */
        @media (max-width: 768px) and (orientation: landscape) {
            .icne-stats {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .ingles-charts-container {
                flex-direction: row;
            }
            
            .pie-wrapper {
                width: 220px;
                height: 220px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Encabezado -->
        <div style="text-align: center; margin-bottom: 20px; background-color: #61828d; padding: 10px; border-radius: 8px;">
            <img src="https://www.ujat.mx/Content/images/escudo.png" alt="Logo" style="height: 80px; display:block; margin: 0 auto 10px auto;">
            <h1 style="margin: 0; color: white;">Resultados del Proceso de Admisión</h1>
            <h1 style="margin: 0; color: white;">Licenciatura y TSU</h1>
            <h1 style="margin: 0; color: white;">Dashboard</h1>
        </div>

        <div id="loadingMessage" class="loading">
            Cargando datos del archivo Excel...
        </div>

        <div id="errorMessage" class="error" style="display: none;">
            <strong>Error:</strong> <span id="errorText"></span>
            <br>
            <button class="retry-button" onclick="cargarExcelEmbebido()">Reintentar</button>
        </div>

        <div id="mainContent" style="display: none;">
            <!-- Filtros -->
            <div class="filters">
                <select id="sistemaSelect" onchange="updatePlantelOptions(); updateDashboard()" disabled>
                    <option value="TODOS">Todos los Sistemas</option>
                </select>
                <select id="plantelSelect" onchange="updateDashboard()" disabled>
                    <option value="TODOS">Todos los Planteles</option>
                </select>
            </div>

            <!-- Estadísticas generales -->
            <div class="icne-stats">
                <div class="stat-box">
                    <div class="stat-label">MÁXIMO DE ICNE</div>
                    <div class="stat-value" id="maxIcne">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">MÍNIMO DE ICNE</div>
                    <div class="stat-value" id="minIcne">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">PROMEDIO DE ICNE</div>
                    <div class="stat-value" id="avgIcne">-</div>
                </div>
            </div>
                
            <div class="icne-stats">    
                <div class="stat-box">
                    <div class="stat-label">TOTAL ASPIRANTES</div>
                    <div class="stat-value" id="totalAspirantes">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ACEPTADOS</div>
                    <div class="stat-value" id="totalAceptados">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">NO ACEPTADOS</div>
                    <div class="stat-value" id="totalNoAceptados">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">% ACEPTACIÓN</div>
                    <div class="stat-value" id="porcentajeAceptacion">-</div>
                </div>
            </div>

            <!-- Gráficas -->
            <div class="grid-container">
                <!-- Gráficas de habilidades individuales -->
                <div class="chart-container">
                    <div class="metric-header">Comprensión Lectora</div>
                    <canvas id="comprensionChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="metric-header">Redacción Indirecta</div>
                    <canvas id="redaccionChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="metric-header">Pensamiento Matemático</div>
                    <canvas id="matematicasChart"></canvas>
                </div>
                
                <!-- Gráfica de inglés que ocupa 2 columnas en desktop -->
                <div class="chart-container two-columns">
                    <div class="metric-header">Nivel de Inglés</div>
                    <div class="ingles-charts-container">
                        <div class="pie-wrapper">
                            <canvas id="suficienciaInglesChart"></canvas>
                        </div>
                        <div class="pie-wrapper">
                            <canvas id="comprensionInglesDINGChart"></canvas>
                        </div>
                    </div>
                    <div class="ingles-labels">
                        <span>Redacción Indirecta</span>
                        <span>Comprensión Lectora</span>
                    </div>
                </div>

                <!-- Gráfica de Top 10 Carreras ocupando toda la fila -->
                <div class="chart-container full-width">
                    <div class="metric-header">Top 10 Carreras Más Solicitadas</div>
                    <canvas id="topCarrerasChart" class="vertical-chart"></canvas>
                </div>
                
                <!-- Gráfica de Carreras del Área de la Salud -->
                <div class="chart-container full-width">
                    <div class="metric-header">Carreras del Área de la Salud</div>
                    <canvas id="carrerasSaludChart" class="vertical-chart"></canvas>
                </div>
                
                <!-- Gráficas de planteles (se muestran condicionalmente) -->
                <div class="chart-container full-width" style="display: none;" id="plantelesAceptadosContainer">
                    <div class="metric-header">Top 10 Planteles con Mayor Número de Aceptados</div>
                    <canvas id="topPlantelesAceptadosChart" class="vertical-chart"></canvas>
                </div>
                
                <div class="chart-container full-width" style="display: none;" id="plantelesNoAceptadosContainer">
                    <div class="metric-header">Top 10 Planteles con Mayor Número de No Aceptados</div>
                    <canvas id="topPlantelesNoAceptadosChart" class="vertical-chart"></canvas>
                </div>
            </div>
        
            <!-- Top 10 mejores puntajes ICNE -->
            <div class="chart-container full-width" style="margin-top: 20px;">
                <div class="metric-header">Top 10 Mejores Puntajes ICNE</div>
                <div class="table-responsive">
                    <table id="topIcneTable" class="table">
                        <thead>
                            <tr>
                                <th>Ubicación</th>
                                <th>Carrera</th>
                                <th>Nombre</th>
                                <th>Apellido Paterno</th>
                                <th>Apellido Materno</th>
                                <th>ICNE</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los datos se llenarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let datos = [];
        let charts = {
            comprension: null,
            redaccion: null,
            matematicas: null,
            inglesComprension: null,
            inglesRedaccion: null,
            suficienciaIngles: null,
            comprensionInglesDING: null,
            topCarreras: null,
            carrerasSalud: null,
            topPlantelesAceptados: null,
            topPlantelesNoAceptados: null
        };

        function mostrarError(mensaje) {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorText').textContent = mensaje;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }

        function mostrarContenido() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        async function cargarExcelEmbebido() {
            try {
                document.getElementById('loadingMessage').style.display = 'block';
                document.getElementById('errorMessage').style.display = 'none';
                document.getElementById('mainContent').style.display = 'none';

                console.log('Iniciando carga del archivo Excel...');
                
                const response = await fetch('/api/fetch-excel');
                
                if (!response.ok) {
                    let errorMessage = `Error HTTP ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                        console.error('Error del servidor:', errorData);
                    } catch (e) {
                        console.error('Error al parsear respuesta de error:', e);
                    }
                    throw new Error(errorMessage);
                }

                console.log('Respuesta recibida, procesando archivo...');
                const arrayBuffer = await response.arrayBuffer();
                
                if (arrayBuffer.byteLength === 0) {
                    throw new Error("El archivo recibido está vacío");
                }

                console.log(`Archivo cargado: ${arrayBuffer.byteLength} bytes`);

                const workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array' });
                
                if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
                    throw new Error("El archivo Excel no contiene hojas de cálculo");
                }

                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                console.log(`Datos procesados: ${jsonData.length} filas`);
                
                if (jsonData.length <= 1) {
                    throw new Error("El archivo Excel está vacío o no tiene el formato esperado");
                }

                // Procesar datos
                const headers = jsonData[0];
                datos = jsonData.slice(1)
                    .filter(row => row && row.length > 0)
                    .map(row => {
                        const obj = {};
                        headers.forEach((header, index) => {
                            obj[header] = row[index];
                        });
                        return obj;
                    });

                if (datos.length === 0) {
                    throw new Error("No se encontraron datos válidos en el archivo");
                }

                console.log(`Datos finales procesados: ${datos.length} registros`);

                // Configurar selectores de filtros
                const sistemaSelect = document.getElementById('sistemaSelect');
                const plantelSelect = document.getElementById('plantelSelect');
                sistemaSelect.disabled = false;
                plantelSelect.disabled = false;

                // Limpiar opciones anteriores
                sistemaSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());
                plantelSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());

                // Poblar opciones para Sistema
                const sistemas = [...new Set(datos.map(item => item['SISTEMA']).filter(Boolean))];
                sistemas.forEach(sis => {
                    const option = document.createElement('option');
                    option.value = sis;
                    option.textContent = sis;
                    sistemaSelect.appendChild(option);
                });

                updatePlantelOptions();
                updateDashboard();
                mostrarContenido();

            } catch (error) {
                console.error("Error detallado:", error);
                mostrarError(`Error al cargar datos: ${error.message}`);
            }
        }

        function updatePlantelOptions() {
            const sistemaSelect = document.getElementById('sistemaSelect');
            const plantelSelect = document.getElementById('plantelSelect');
            const selectedSistema = sistemaSelect.value;
            
            plantelSelect.querySelectorAll('option:not(:first-child)').forEach(option => option.remove());
            
            let planteles = [];
            if (selectedSistema === "TODOS") {
                planteles = [...new Set(datos.map(item => item['PLANTEL']).filter(Boolean))];
            } else {
                planteles = [...new Set(datos.filter(item => item['SISTEMA'] === selectedSistema)
                                            .map(item => item['PLANTEL']).filter(Boolean))];
            }
            
            planteles.forEach(plant => {
                const option = document.createElement('option');
                option.value = plant;
                option.textContent = plant;
                plantelSelect.appendChild(option);
            });
            plantelSelect.value = "TODOS";
        }

        function actualizarTablaTopIcne(filteredData) {
            const tableBody = document.querySelector('#topIcneTable tbody');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';

            if (filteredData.length > 0) {
                console.log("Campos disponibles:", Object.keys(filteredData[0]));
            }

            const topData = [...filteredData]
                .filter(item => item.ICNE)
                .sort((a, b) => parseFloat(b.ICNE || 0) - parseFloat(a.ICNE || 0))
                .slice(0, 10);

            topData.forEach(item => {
                const ubicacion = `${item.SISTEMA || ''} - ${item.PLANTEL || ''}`;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${ubicacion}</td>
                    <td>${item.CARRERA || '-'}</td>
                    <td>${item.NOMBRE || '-'}</td>
                    <td>${item.PRIM_APE || '-'}</td>
                    <td>${item.SEGU_APE || '-'}</td>
                    <td><strong>${parseFloat(item.ICNE || 0).toFixed(0)}</strong></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function updateDashboard() {
            if (datos.length === 0) return;
            
            const selectedSistema = document.getElementById('sistemaSelect').value;
            const selectedPlantel = document.getElementById('plantelSelect').value;
            const filteredData = datos.filter(item => {
                let condition = true;
                if (selectedSistema !== 'TODOS') condition = condition && (item['SISTEMA'] === selectedSistema);
                if (selectedPlantel !== 'TODOS') condition = condition && (item['PLANTEL'] === selectedPlantel);
                return condition;
            });

            // Actualizar estadísticas generales
            const totalAspirantes = filteredData.length;
            const totalAceptados = filteredData.filter(item => item.DICTAMEN?.toUpperCase() === 'ACEPTADO').length;
            const totalNoAceptados = totalAspirantes - totalAceptados;
            const porcentajeAceptacion = totalAspirantes > 0 ? ((totalAceptados / totalAspirantes) * 100).toFixed(1) : 0;

            document.getElementById('totalAspirantes').textContent = totalAspirantes;
            document.getElementById('totalAceptados').textContent = totalAceptados;
            document.getElementById('totalNoAceptados').textContent = totalNoAceptados;
            document.getElementById('porcentajeAceptacion').textContent = porcentajeAceptacion + '%';

            // Actualizar estadísticas ICNE
            const icneValues = filteredData.map(item => parseFloat(item.ICNE) || 0);
            const maxIcne = icneValues.length ? Math.max(...icneValues).toFixed(0) : '-';
            const minIcne = icneValues.length ? Math.min(...icneValues).toFixed(0) : '-';
            const avgIcne = icneValues.length ? (icneValues.reduce((a, b) => a + b, 0) / icneValues.length).toFixed(0) : '-';
        
            document.getElementById('maxIcne').textContent = maxIcne;
            document.getElementById('minIcne').textContent = minIcne;
            document.getElementById('avgIcne').textContent = avgIcne;

            // Mostrar/ocultar contenedores según filtros
            const showPlantelCharts = selectedSistema !== 'TODOS' && selectedPlantel === 'TODOS';
            
            document.getElementById('plantelesAceptadosContainer').style.display = showPlantelCharts ? 'block' : 'none';
            document.getElementById('plantelesNoAceptadosContainer').style.display = showPlantelCharts ? 'block' : 'none';

            // Destruir gráficas anteriores
            Object.keys(charts).forEach(key => {
                if (charts[key]) {
                    charts[key].destroy();
                    charts[key] = null;
                }
            });

            // Función para calcular promedios
            const promedio = (key) => {
                const total = filteredData.reduce((sum, item) => sum + (parseFloat(item[key]) || 0), 0);
                return filteredData.length ? (total / filteredData.length).toFixed(2) : 0;
            };

            // Configuración común para gráficas de habilidades
            const commonOptions = {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'center',
                        align: 'center',
                        color: '#ffffff',
                        font: { 
                            weight: 'bold', 
                            size: 14 
                        },
                        formatter: value => `${value}%`,
                        offset: 10
                    }
                },
                scales: { x: { max: 100, beginAtZero: true } }
            };

            // Crear gráficas de habilidades
            charts.comprension = crearGraficaHabilidad(
                'comprensionChart',
                ['Ámbito Estudio', 'Ámbito de Participación Social', 'Ámbito Literario'],
                ['PCLE_AE', 'PCLE_APS', 'PCLE_AL'],
                ['#3498db', '#2ecc71', '#9b59b6'],
                promedio,
                commonOptions
            );
           
            charts.redaccion = crearGraficaHabilidad(
                'redaccionChart',
                ['Ámbito Estudio', 'Ámbito Participación Social'],
                ['PRIN_ES', 'PRIN_PS'],
                ['#e67e22', '#f1c40f'],
                promedio,
                commonOptions
            );

            charts.matematicas = crearGraficaHabilidad(
                'matematicasChart',
                ['Comprensión Matemática', 'Matematización'],
                ['PPMA_CM', 'PPMA_MA'],
                ['#e74c3c', '#1abc9c'],
                promedio,
                commonOptions
            );

            // Crear gráficas de inglés
            crearGraficasIngles(filteredData);

            // Procesar y mostrar gráficas de carreras
            actualizarGraficaCarreras('topCarreras', filteredData);
            actualizarGraficaCarreras('carrerasSalud', filteredData, [
                'MÉDICO CIRUJANO',
                'CIRUJANO DENTISTA',
                'LICENCIADO EN ENFERMERÍA',
                'LICENCIADO EN PSICOLOGÍA'
            ]);

            // Crear gráficas de planteles solo si se cumple la condición
            if (showPlantelCharts) {
                const dataAceptados = procesarPlanteles(filteredData, 'aceptados');
                crearGraficaPlanteles(
                    'topPlantelesAceptados',
                    'topPlantelesAceptadosChart',
                    dataAceptados,
                    '#27ae60',
                    'Aceptados'
                );

                const dataNoAceptados = procesarPlanteles(filteredData, 'noAceptados');
                crearGraficaPlanteles(
                    'topPlantelesNoAceptados',
                    'topPlantelesNoAceptadosChart',
                    dataNoAceptados,
                    '#e74c3c',
                    'No Aceptados'
                );
            }

            actualizarTablaTopIcne(filteredData);
        }

        // Función para crear gráficas de habilidades
        function crearGraficaHabilidad(canvasId, labels, keys, colores, promedio, commonOptions) {
            return new Chart(document.getElementById(canvasId), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Porcentaje',
                        data: keys.map(k => promedio(k)),
                        backgroundColor: colores,
                        borderWidth: 1
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { 
                            display: false
                        },
                        datalabels: {
                            anchor: 'center',
                            align: 'center',
                            color: '#ffffff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: value => `${value}%`,
                            offset: 10
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
            
        function crearGraficasIngles(data) {
            const procesarIngles = (campo, colores) => {
                const counts = data.reduce((acc, item) => {
                    const valor = parseInt(item[campo]) || 0;
                    acc[valor === 2 ? 1 : 0]++;
                    return acc;
                }, [0, 0]);
                
                return {
                    labels: ['No Satisfactorio', 'Satisfactorio'],
                    datasets: [{
                        data: counts,
                        backgroundColor: colores
                    }]
                };
            };

            // Destruir gráficas anteriores si existen
            if (charts.suficienciaIngles) {
                charts.suficienciaIngles.destroy();
            }
            if (charts.comprensionInglesDING) {
                charts.comprensionInglesDING.destroy();
            }

            charts.suficienciaIngles = new Chart(document.getElementById('suficienciaInglesChart'), {
                type: 'doughnut',
                data: procesarIngles('DING_RI', ['#e74c3c', '#2ecc71']),
                options: configPie,
                plugins: [ChartDataLabels]
            });

            charts.comprensionInglesDING = new Chart(document.getElementById('comprensionInglesDINGChart'), {
                type: 'doughnut',
                data: procesarIngles('DING_CL', ['#e74c3c', '#2ecc71']),
                options: configPie,
                plugins: [ChartDataLabels]
            });
        }

        function actualizarGraficaCarreras(chartKey, filteredData, filtroCarreras = null) {
            const chartId = chartKey + 'Chart';
            const ctx = document.getElementById(chartId);
            const data = procesarCarreras(filteredData, filtroCarreras);
            
            if (charts[chartKey]) {
                charts[chartKey].destroy();
            }
            
            charts[chartKey] = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { 
                        x: { stacked: false }, 
                        y: { stacked: false, beginAtZero: true } 
                    },
                    plugins: {
                        legend: { position: 'top' },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#000',
                            font: { weight: 'bold' },
                            formatter: value => value > 0 ? value : ''
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function procesarPlanteles(filteredData, tipo) {
            const plantelData = filteredData.reduce((acc, item) => {
                const plantel = item.PLANTEL;
                if (!plantel) return acc;
            
                if (!acc[plantel]) acc[plantel] = 0;
            
                if ((tipo === 'aceptados' && item.DICTAMEN?.toUpperCase() === 'ACEPTADO') ||
                    (tipo === 'noAceptados' && item.DICTAMEN?.toUpperCase() !== 'ACEPTADO')) {
                    acc[plantel]++;
                }
            
                return acc;
            }, {});

            return Object.entries(plantelData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10)
                .map(([nombre, cantidad]) => ({ nombre, cantidad }));
        }

        // Función auxiliar para crear gráficas de planteles
        function crearGraficaPlanteles(chartKey, canvasId, data, color, label) {
            const ctx = document.getElementById(canvasId);
            
            if (charts[chartKey]) charts[chartKey].destroy();
            
            // Esperar a que el DOM se actualice
            setTimeout(() => {
                charts[chartKey] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(d => d.nombre),
                        datasets: [{
                            label: label,
                            data: data.map(d => d.cantidad),
                            backgroundColor: color,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: false,
                        layout: {
                            padding: {
                                left: 10,
                                right: 40,
                                top: 10,
                                bottom: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#000',
                                font: { 
                                    weight: 'bold',
                                    size: 12
                                },
                                formatter: value => value,
                                offset: 5
                            }
                        },
                        scales: {
                            x: { 
                                beginAtZero: true,
                                ticks: {
                                    maxTicksLimit: 8
                                }
                            },
                            y: { 
                                ticks: { 
                                    autoSkip: false,
                                    maxTicksLimit: 10,
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }, 100);
        }

        // Función modificada para recibir filteredData como parámetro
        function procesarCarreras(filteredData, filtro = null) {
            const carrerasData = filteredData.reduce((acc, item) => {
                const carrera = item.CARRERA?.toUpperCase();
                if (!carrera) return acc;
                
                if (!acc[carrera]) acc[carrera] = { aceptados: 0, noAceptados: 0 };
                
                item.DICTAMEN?.toUpperCase() === 'ACEPTADO' 
                    ? acc[carrera].aceptados++ 
                    : acc[carrera].noAceptados++;
                
                return acc;
            }, {});

            let carreras = Object.entries(carrerasData);
            
            if (filtro) {
                carreras = carreras.filter(([nombre]) => filtro.includes(nombre));
            } else {
                carreras = carreras.sort((a, b) => 
                    (b[1].aceptados + b[1].noAceptados) - (a[1].aceptados + a[1].noAceptados)
                ).slice(0, 10);
            }

            return {
                labels: carreras.map(([nombre]) => nombre),
                datasets: [
                    {
                        label: 'Aceptados',
                        data: carreras.map(([, datos]) => datos.aceptados),
                        backgroundColor: '#27ae60'
                    },
                    {
                        label: 'No Aceptados',
                        data: carreras.map(([, datos]) => datos.noAceptados),
                        backgroundColor: '#e74c3c'
                    }
                ]
            };
        }

        // Configuración común para gráficas de tipo pie
        const configPie = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: { size: 12 },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map((label, i) => {
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const value = data.datasets[0].data[i];
                                    const percentage = total === 0 ? '0%' : ((value / total) * 100).toFixed(2) + '%';
                                    
                                    return {
                                        text: `${label}: ${value} (${percentage})`,
                                        fillStyle: data.datasets[0].backgroundColor[i],
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.raw || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total === 0 ? '0%' : ((value / total) * 100).toFixed(1) + '%';
                            return `${label}: ${value} (${percentage})`;
                        }
                    }
                },
                datalabels: {
                    color: '#ffffff',
                    font: { 
                        weight: 'bold', 
                        size: 14 
                    },
                    formatter: (value, context) => {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        return total === 0 ? '0%' : ((value / total) * 100).toFixed(1) + '%';
                    },
                    anchor: 'center',
                    align: 'middle'
                }
            }
        };

        // Cargar el Excel automáticamente al abrir la página
        window.onload = cargarExcelEmbebido;
    </script>
</body>
</html>
